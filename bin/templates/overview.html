{% extends "base.html" %}
{% block content %}


<!-- Page Heading -->
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Overview of data</h1>
</div>
<p class="mb-4">
    The following interface serves as a visualization of the results produced by TSS-CAPTUR. The possibility exists
    between an <a href="overview.html">overview</a> of all results or the detailed results of the <a
        href="classified.html">classification</a> or the <a href="terminators.html">terminator allocation</a> steps of
    TSS-CAPTUR. The possibility of some TSS being ignored by TSS-CAPTUR due to their short lenght exists. They are found
    <a href="avoided.html">here</a> .
</p>
<p class="mb-4">The current page presents an overview of the results of all steps run in TSS-CAPTUR, for example, the
    length of the transcript originally extracted from the genome and the predicted classification.
    In the case of RNA-transcripts, a terminator might have been allocated to the transcript and the coordinates would
    have been adapted. Also, a secondary structure analysis is run for RNA transcripts and allows a visualization of it.
    All transcript undergo a motif analysis of the promoter region using MEME. A short descriptive overview follows:
</p>





<div class="row">

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            Total of TSS</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800"><span id="allTSS"></span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div id="orphan-card" class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            Total of Orphan TSS</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800"><span id="OTSS"></span></div>
                        <div class="h6 mb-0 font-weight-bold text-gray-800">Coding: <span id="CodingOTSS"></span>
                        </div>
                        <div class="h6 mb-0 font-weight-bold text-gray-800">ncRNAs: <span id="ncOTSS"></span></div>
                        <div id="not-classified-or" class="h6 mb-0 font-weight-bold text-gray-800">Not classified:
                            <span id="noclassOR"></span>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div id="as-card" class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            Total of Antisense TSS</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800"><span id="ATSS"></span></div>
                        <div class="h6 mb-0 font-weight-bold text-gray-800">Coding: <span id="CodingATSS"></span>
                        </div>
                        <div class="h6 mb-0 font-weight-bold text-gray-800">ncRNAs: <span id="ncATSS"></span></div>
                        <div id="not-classified-as" class="h6 mb-0 font-weight-bold text-gray-800">Not classified:
                            <span id="noclassAS"></span>
                        </div>

                    </div>

                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-danger shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                            Total of <a href="avoided.html">ignored TSS</a></div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800"><span id="iTSS"></span></div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Content Row -->
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Overview of TSS characterization</h6>
    </div>
    <div class="card-body">

        <div class="row">

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <a data-toggle="collapse" href="#collapseColumnsChoice" aria-expanded="false"
                                aria-controls="collapseColumnsChoice">
                                Select columns</a>
                        </h6>
                    </div>
                    <div class="collapse" id="collapseColumnsChoice">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <!-- <div style="scroll-behavior: auto; max-height:100px"> -->
                                    <div>
                                        <form id=selectionColumns>
                                        </form>
                                    </div>

                                    <a onclick="updateColumns()" class="btn btn-info btn-icon-split"
                                        style="float: right;">
                                        <span class="icon text-white-50">
                                            <i class="fas fa-info-circle"></i>
                                        </span>
                                        <span class="text">Show columns</span>
                                    </a>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <a href="#" class="btn btn-info btn-icon-split">
                    <span class="icon text-white-50">
                        <i class="fas fa-info-circle"></i>
                    </span>
                    <span class="text">Select all?</span>
                </a>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <a href="#" class="btn btn-info center btn-icon-split">
                    <span class="icon text-white-50">
                        <i class="fas fa-info-circle"></i>
                    </span>
                    <span class="text">Filter</span>
                </a>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <a href="#" class="btn btn-info btn-icon-split">
                    <span class="icon text-white-50">
                        <i class="fas fa-info-circle"></i>
                    </span>
                    <span class="text">Export</span>
                </a>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered" id="dataTableOverview" cellspacing="0">

            </table>
        </div>
    </div>
</div>
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">
            <a data-toggle="collapse" href="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
                View RNA structure</a>
        </h6>
    </div>
    <div class="collapse" id="collapseExample">
        <div class="card shadow mb-4">
            <img id="vizStructure" src="" width=70% class="rounded mx-auto d-block" alt="Not yet selected">
        </div>
    </div>
</div>

<script type='text/javascript'>
    const FROM_COLNAME_TO_TITLE = {
        "index": { title: "Transcript ID", default: true, category: "main" },
        "position": { title: "TSS Position", default: true, category: "main" },
        "strand": { title: "Strand", default: true, category: "main" },
        "transcript_length": { title: "Extracted length", default: true, category: "main" },
        "winner": { title: "Gene class", default: true, category: "main" },
        "feature": { title: "Predicted terminator", default: true, category: "main" },
        "term_start": { title: "Term. start", default: true, category: "main" },
        "term_end": { title: "Term. end", default: true, category: "main" },
        "mfe": { title: "MFE (kcal/mol)", default: true, category: "main" },
        "summary": { title: "Promoter motifs", renderTitle: returnMotifSummary, default: true, category: "main" },
        "GeneStart": { title: "Gene start", default: true, category: "main" },
        "GeneEnd": { title: "Gene end", default: true, category: "main" },
        "GeneLength": { title: "Gene length", default: true, category: "main" },
        "GeneLengthWithUTR": { title: "Length with 5' UTR", default: true, category: "main" },
        "url_for_image": { title: "RNA-Structure", default: true, category: "main" },
    }

    function returnMotifSummary(summary) {
        return `<a target="_blank" rel="noopener noreferrer"    data-html="true" class="wide-tooltip link-to-motif" data-toggle="tooltip" title="${summary}">Promoter motifs</a>`
    }


    function updateColumns() {
        let elements = $("#selectionColumns").find("input:checked")
        let colnames = Object.values(elements).map(el => el.value);
        let colDefToHide = columnNames[genome_selected].map((x,d) => [x,d]).filter(el => !colnames.includes(el[0]) )
         // set all columns to visible to afterwards hide the ones that are unselected
        $("#dataTableOverview").DataTable().columns().visible(true);
        $("#dataTableOverview").DataTable().columns(colDefToHide.map(x => x[1]+1)).visible(false);

        

    }

    index = localStorage.getItem("genome") ? localStorage.getItem("genome") : 0;
    genome_selected = genomes[index];
    let dataOverview = overviewData[genome_selected].map(x => [""].concat(x));
    console.log(dataOverview);
    // console.log(dataOverview.forEach());
    // dataOverview = dataOverview.map(x => x.unshift(""))
    let dataSummary = summaryMotifs[genome_selected];
    let summary = dataSummary.map(x => `${x[0]} (${x[1]})<br/>Appears ${x[3]} times (E-value: ${x[2].toExponential(2)})`).join("<br/>");



    function createCheckbox(name) {
        let idCheckbox = `checkbox-${name}`
        let is_checked = (FROM_COLNAME_TO_TITLE[name].default) ? "checked" : ''
        return `<div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${name}" id="${idCheckbox}" ${is_checked} />
                    <label class="form-check-label" for= "${idCheckbox}" >
                        ${FROM_COLNAME_TO_TITLE[name].title}
                    </label >
                    </div> `
    }

    function prepareColumnSelection() {
        for (let colName of columnNames[genome_selected]) {
            $("#selectionColumns").append(createCheckbox(colName));
        }

    }


    function modifyingCSV (csv, a, b, c) {
        //Split the csv to get the rows
        var split_csv = csv.split("\n");
        console.log(csv);
        console.log("test");
        console.log(csv, a, b, c);
        //For each row except the first one (header)
        $.each(split_csv.slice(1), function (index, csv_row) {
                //Split on quotes and comma to get each cell
                var csv_cell_array = csv_row.split('","');

        //         //Remove replace the two quotes which are left at the beginning and the end (first and last cell)
                csv_cell_array[0] = csv_cell_array[0].replace(/"/g, '');
                csv_cell_array[3] = csv_cell_array[3].replace(/"/g, '');

        //         //RANDOM EXAMPLE : Make some test, special cutomizing depending of the value of the cell (if cell 5 is equal to a certain value, give a value to row 6)
        //         if (csv_cell_array[5].toLowerCase().trim() == "a certain value") {
        //                 csv_cell_array[6] = "2";
        //         }
        //         else if (csv_cell_array[5].toLowerCase() == "another value") {
        //                 csv_cell_array[6] = "5";
        //         }
        //         //Else, define an empty 6th cell
        //         else {
        //                 csv_cell_array[6] = "";
        //         }

        //         //RANDOM EXAMPLE : Empty the 5th cell and set the 7th to true
                csv_cell_array[5] = "";
        //         csv_cell_array[7] = "true";

        //         //Join the table on the quotes and comma; add back the quotes at the beginning and end
        //         csv_cell_array_quotes = '"' + csv_cell_array.join('","') + '"';

        //         //Insert the new row into the rows array at the previous index (index +1 because the header was sliced)
        //         split_csv[index + 1] = csv_cell_array_quotes;
        });

        //Join the rows with line breck and return the final csv (datatables will take the returned csv and process it)
        csv = split_csv.join("\n");
        return csv;
    }

    $(document).ready(function () {

        prepareColumnSelection();

        $("#dataTableOverview").DataTable({
            dom: "Blfrtip",
            buttons: [{
                extend: 'colvis',
                text: "Select Columns",
                
            } , {
                extend: 'collection',
                text: 'Export CSV',
                buttons: [
                {
                    extend: 'csv', 
                    text: "Export all", 
                    exportOptions: {
                        modifier: {
                            search: 'none', 
                            selected: 'none',
                            
                        },
                        columns: [":not(.select-checkbox):visible"],
                        
                    },
                    customize: modifyingCSV
                },{
                    extend: 'csv', 
                    text: "Export selected", 
                    exportOptions: {
                        modifier: {
                            selected:true
                        },
                        columns: [":not(.select-checkbox):visible"]

                    }
                }, {
                    extend: 'csv', 
                    text: "Export filtered", 
                    exportOptions: {
                        modifier: {
                            search: 'applied'
                        },
                        columns: [":not(.select-checkbox):visible"]

                    }
                }
                ]
            }
                ,
            {
                extend: 'selected',
                text: "Export GFF",
            }
            ],
            select: {
                style: 'os',
                selector: 'td:first-child'
            },
            "scrollX": true,
            "scrollY": $(window).height() * 0.8,
            "scrollCollapse": true,
            columnDefs:
                [{
                    targets: 0,
                    data: null,
                    defaultContent: '',
                    orderable: false,
                    className: 'select-checkbox',
                    name: 'select-column'
                },
                {
                    "targets": 1,
                    type: "natural"
                },
                {
                    "targets": 15,
                    "render": function (data, type, row, meta) {
                        if (data != "") {
                            return '<a href="#" onclick=updateViz("' + row[14] + '")>Show</a>';
                        } else {
                            return ""
                        }
                    }
                },
                {
                    "targets": 10,
                    "render": function (data, type, row, meta) {
                        if (data != "NA") {
                            let string = data.map(x => `${x[0]} found at crd.${x[1] - 51} (p - value: ${x[2].toExponential(2)})`)
                            return `<a target="_blank" rel = "noopener noreferrer"  data-container="body" href = "../MotifAnalysis/${genome_selected}/meme_out/meme.html" data-html="true" data-toggle="tooltip" class="header-tooltip link-to-motif" title = "${string.join(" <br /> ")}"> ${data.length} motifs found </a > `;
                        } else {
                            return ""
                        }

                    }
                },
                {
                    "targets": 9,
                    "type": "natural",
                    "render": function (data, type, row, meta) {
                        if (data != "NA") {
                            return parseFloat(row[9]).toFixed(2)
                        } else {
                            return "NA"
                        }

                    }
                }],
            order: [[1, "asc"]],
            data: dataOverview,
            columns: [
                { title: "Select" },
                { title: "Transcript ID" },
                { title: "Position" },
                { title: "Strand" },
                { title: "Extracted Length" },
                { title: "Class" },
                { title: "Type of Terminator" },
                { title: "Terminator Start" },
                { title: "Terminator End" },
                { title: "MFE (kcal/mol)" },
                { title: returnMotifSummary(summary) },
                { title: "Gene Start" },
                { title: "Gene End" },
                { title: "Length of Gene" },
                { title: "Length with 5'UTR" },
                { title: "RNA-Struct" },
            ],
        });
    });


    $(document).ready(function () {
        $('body').tooltip({
            selector: '[data-toggle="tooltip"]'
        });
        updateSummary(genome_selected);


    });


    $(`.link-to-motif`).each(function () {
        $(this).attr("href", `../MotifAnalysis/${genome_selected}/meme_out/meme.html`);
    });

</script>

{% endblock %}